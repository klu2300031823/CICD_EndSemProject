---
- name: Fullstack App Deployment on WSL
  hosts: localhost
  connection: local
  gather_facts: yes

  vars:
    k8s_manifest_path: "../k8s/fullstackdeployment.yaml"
    # These are LOCAL ports on your machine via port-forward (match your repo config)
    frontend_nodeport: 8094
    backend_nodeport: 8095

  tasks:

    - name: Gather system facts
      ansible.builtin.setup:

    - name: Ensure Docker service is running
      ansible.builtin.service:
        name: docker
        state: started
        enabled: yes

    - name: Start Minikube (if not running)
      ansible.builtin.shell: |
        if ! minikube status 2>/dev/null | grep -q "Running"; then
          echo "Starting Minikube using Docker driver..."
          minikube start --driver=docker --memory=2000 --cpus=2
        else
          echo "Minikube already running."
        fi
      args:
        executable: /bin/bash

    - name: Copy Kubernetes deployment file
      ansible.builtin.copy:
        src: "{{ k8s_manifest_path }}"
        dest: /tmp/fullstackdeployment.yaml
        force: yes

    - name: Apply Kubernetes manifests
      ansible.builtin.shell: kubectl apply -f /tmp/fullstackdeployment.yaml
      args:
        executable: /bin/bash

    - name: Wait for all pods to be running
      ansible.builtin.shell: |
        kubectl get pods --no-headers | grep -v Running || true
      register: pod_status
      until: pod_status.stdout == ""
      retries: 20
      delay: 10
      args:
        executable: /bin/bash

    - name: Display all services
      ansible.builtin.shell: kubectl get svc
      register: svc_output
      args:
        executable: /bin/bash

    - name: Print services table
      ansible.builtin.debug:
        msg: "{{ svc_output.stdout }}"

    # ---------------------------------------------------
    # Port-forward so your apps are reachable on localhost
    # Frontend: http://localhost:8094/ecommerce/
    # Backend:  http://localhost:8095/back1/
    # ---------------------------------------------------
    - name: Forward backend service port {{ backend_nodeport }} -> 8080 (background)
      ansible.builtin.shell: |
        nohup kubectl port-forward svc/backend {{ backend_nodeport }}:8080 >/dev/null 2>&1 &
      args:
        executable: /bin/bash

    - name: Forward frontend service port {{ frontend_nodeport }} -> 8080 (background)
      ansible.builtin.shell: |
        nohup kubectl port-forward svc/frontend {{ frontend_nodeport }}:8080 >/dev/null 2>&1 &
      args:
        executable: /bin/bash

    - name: Show access URLs
      ansible.builtin.debug:
        msg:
          - "✅ Frontend: http://localhost:{{ frontend_nodeport }}/exam/"
          - "✅ Backend:  http://localhost:{{ backend_nodeport }}/back1/"
